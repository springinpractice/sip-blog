
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring in Practice</title>
  <meta name="author" content="Willie Wheeler">

  
  <meta name="description" content="I&rsquo;m at SpringOne right now, and very much enjoying the Westin Diplomat. My room is on the 21st floor and it overlooks the Atlantic. My balcony &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://springinpractice.com/blog/page/6">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Spring in Practice" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Forum' rel='stylesheet' type='text/css'>

  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <ul class="social-links">
    <li><a href="https://twitter.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/twitter.png" alt="Twitter" /></a></li>
    <li><a href="https://github.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/github.png" alt="GitHub" /></a></li>
    <li><a href="http://stackoverflow.com/users/41871/willie-wheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/stackoverflow.png" alt="Stack Overflow" /></a></li>
    <li><a href="http://www.linkedin.com/in/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/linkedin.png" alt="LinkedIn" /></a></li>
  </ul>
  <h1><a href="/">Spring in Practice</a></h1>
  
    <h2>Willie Wheeler's Spring blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/consulting/">Consulting</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/12/01/rod-johnsons-keynote-address-at-springone-americas-2008/">Rod Johnson&#8217;s Keynote Address at SpringOne Americas 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-01T14:44:13-08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m at SpringOne right now, and very much enjoying the <a href="http://www.diplomatresort.com/">Westin Diplomat</a>. My room is on the 21st floor and it overlooks the Atlantic. My balcony door is open and I can hear the waves crashing on the shore as I write. This is how life should always be. :&ndash;)</p>

<p>I attended Rod Johnson&rsquo;s keynote a couple of hours back. The keynote itself was informative, offering a pretty good glimpse into where SpringSource sees itself going over the coming year, and I had a chance to chat it up with Thomas Risberg and Colin Sampaleanu just a little bit since we were all sitting at the same table. Recognizing an opportunity when I see one, I asked them when they thought Spring 3 would be coming out and they laughed in a way that suggested that this wasn&rsquo;t the first time somebody had asked. Right now they&rsquo;re shooting for late March or thereabouts, though that was just their impression as opposed to a definite statement.</p>

<p>Anyway, here are some highlights from the keynote.</p>

<h3>SpringSource in 2008</h3>


<p>Rod started the keynote with some SpringSource efforts and accomplishments over 2008. I won&rsquo;t go into those in detail, but he mentioned several items, including</p>

<ul>
    <li><a href="http://www.springsource.org/webflow">Spring Web Flow 2.0</a> GA: I remember it well as I wrote <a href="http://wheelersoftware.com/articles/spring-web-flow-2.0.html">an article</a> about it just before the GA and I wanted to make sure that nothing important had changed.</li>
    <li><a href="http://static.springsource.org/spring-batch/">Spring Batch</a> GA</li>
    <li>Launched new <a href="http://www.springsource.org/spring-integration">Spring Integration</a> project</li>
    <li>Preparing for Spring 3.0 GA</li>
    <li><a href="http://www.springsource.com/products/suite/dmserver">SpringSource dm Server</a></li>
    <li><a href="http://www.regdeveloper.co.uk/2008/01/29/springsource_buys_covalent/">Covalent Technologies acquisition</a>: ten years supporting Apache HTTP server and leading support provider for Tomcat (which is important to SpringSource&#8217;s strategy, as I&#8217;ll describe below)</li>
    <li><a href="http://broadcast.oreilly.com/2008/11/springsource-getting-into-the.html">G2One acquisition</a>: Bringing Groovy and Grails into SpringSource</li>
    <li>Several commercial software releases, including the <a href="http://www.springsource.com/products/suite/sts">SpringSource Tool Suite</a>, <a href="http://www.springsource.com/products/suite/ams">SpringSource Application Management Suite</a> and the <a href="http://www.springsource.com/products/suite/apfororacledb">SpringSource Advanced Pack for Oracle</a>.</li>
</ul>


<p>They&rsquo;ve clearly been a busy company over the past year, but it may not be entirely clear what they&rsquo;re up to. (Well, part of it is clear enough&mdash;they&rsquo;re moving into the app server space.) The next part of the keynote explained where SpringSource is going as a company.</p>

<h3>SpringSource in 2009</h3>


<p>Rod noted that 2008 has been a tough year for the world economy in general, and thus one reasonable prediction is that that&rsquo;s going to translate into pressure on IT budgets. One development he expects to see is license costs coming under increased scrutiny. Another is that he thinks IT will begin paying more attention to the costs associated with complexity, and will invest more in reducing that complexity.</p>

<p>I know from my own workplace that his ideas here are correct. Even before news broke that everything&rsquo;s melting down, we were reevaluating our license situation and indeed even in some cases making changes. And one of the themes that our CIO has sounded time and time again is that we need to work to reduce complexity when we can. I suspect that these are common themes anyway, but with the tough economic times it&rsquo;s pretty easy to believe that one can build a business strategy around this, and that&rsquo;s what SpringSource is doing.</p>

<h3>The SpringSource strategy: help customers control costs by managing and reducing complexity</h3>


<p>This was really the theme of the keynote and Rod noted that they&rsquo;d even changed their tagline to reflect it: &ldquo;Weapons for the War on Java Complexity.&rdquo; He explained how the various efforts over 2008 are generally aligned with managing complexity on different fronts. For example:</p>

<p><b>Continue targeting complexity in development by expanding the Spring Framework in a way that simplifies application development.</b> Rod showed how with each new release of Spring, the SLOC for the pet store application dropped. He highlighted Spring Web MVC, Spring Web Flow and the acquisition of G2One in particular as representing a continued commitment to simplifying application development. Another notable item here includes Spring 2.5-style configuration via annotations.</p>

<p>Spring 3.0 moves the platform further along in this simplifying direction. Some highlights:</p>

<ul>
    <li>Spring 3.0 will support EL in XML configuration and in annotations. He didn&#8217;t say exactly where this would appear.</li>
    <li>Spring Web MVC will provide first-class support for RESTful web services. The match is strong (Spring Web MVC already has a @RequestMapping attribute that serves well here), and RESTful remoting is simpler than say SOAP-based web services.</li>
    <li>With Spring Web MVC, developers should adopt the annotated POJO model as Spring 3.0 will deprecate the Controller hierarchy and 3.1 will probably eliminate it altogether. Again the argument is that this is simpler than XML configuration.</li>
    <li>Spring Web Flow should be seen not as a niche technology but as a core part of their web framework that potentially applies any time there&#8217;s a directed navigation requirement. Examples include wizards, back button, refresh, multiple UIs, and UI reuse.</li>
    <li>Speaking of their web framework, they&#8217;re treating the following four projects as constituting a coherent, layered set: Spring Web MVC (the core), Spring JavaScript and Spring Web Flow (sitting on top of Spring Web MVC), and Spring Faces (sitting on top of the other three). He said that historically Spring hadn&#8217;t simplified web development as much as it could have, and their converging the four aforementioned web technologies into a single group is an effort to address this.</li>
</ul>


<p>Finally (we&rsquo;re still on the topic of managing complexity in development), Rod suggested that we take a look at <a href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/beans/factory/annotation/Configurable.html">@Configurable</a> (which was available in Spring 2.0) and consider it a &ldquo;secret weapon&rdquo; against complexity.</p>

<p>The other major way in which SpringSource aims to manage/reduce complexity:</p>

<p><b>Target complexity not only in development but also in operations:</b> Though it&rsquo;s by no means unanimous, lots of people feel that Spring has done a pretty nice job of simplifying JEE development. Their idea is now to take that to the data center. Their commercial offerings align with this; for example, the Application Management Suite provides deep diagnostics for Spring-based applications, and the dm Server aims to make release management simpler and more flexible. Besides their commercial offerings, their investment in Covalent Technologies (better access to Apache and Tomcat expertise) represents a desire to strengthen their offering in hosting and operations.</p>

<p>They see Tomcat as being the platform of choice where WAR-based deployments are concerned, but they see server-side OSGi as the wave of the future. Because Tomcat is currently widely deployed (I think Rod said something like 70% of enterprises have deployed Tomcat?), SpringSource wants to be involved there, and that&rsquo;s why they bought Covalent. But at the same time they are trying to encourage their customers and indeed the industry at large to make the transition to OSGi-based deployment.</p>

<p>And this leads to a couple of announcements he made.</p>

<h3>A couple of product announcements</h3>


<p><b>tc Server:</b> The first announcement was that SpringSource will be releasing another server product to complement their current dm Server offering. This one is called tc Server for (you guessed it) Tomcat Server, and the idea is that it&rsquo;s an enhanced version of Tomcat, one that includes management functionality to make it &ldquo;ready for the data center.&rdquo; The AMS product comes with it, and it will provide features such as visibility into Tomcat and app performance stats, deadlock detection, heap and thread dumps, and stuff like that. It will also be possible to manage tc Server WAR deployments through AMS. They&rsquo;re expecting (if I understood correctly) a GA release in January 2009.</p>

<p>Rod emphasized that the Spring Framework itself would remain server-agnostic, despite the fact that SpringSource is a server vendor.</p>

<p><b>SpringSource Application Platform Configurator:</b> The second announcement is that SpringSource will be making available a web application called the SpringSource Application Platform Configurator. Again, managing complexity is the driver here. This time they are addressing the complexity associated with managing dependencies between JAR files, eliminating version conflicts, and that sort of thing. The idea is that you go to this app (which they host), and you specify a bunch of parameters such as the app type (web app, Grails, batch, etc.), whether you&rsquo;re OK with including pre-release software (such as milestone releases) or whether you allow only GAs, what sorts of capabilities you want and where your religious allegiances lie (is it OK to include JSF? is it OK to include Flex?), what hosting provider you&rsquo;re using (WebSphere, WebLogic, dm Server, etc.), what OS, etc. (By the way, they don&rsquo;t explicitly ask &ldquo;where are your religious allegiances,&rdquo; but Rod noted that they recognize this reality of how software is sometimes chosen and the configurator is designed accordingly.) Then at the end you register (free), get a text dump of the JARs you just chose, and get a dynamically-generated ZIP containing those JARs (and they&rsquo;re of course mutually consistent so as to avoid versioning conflicts). That&rsquo;s a cool idea. They don&rsquo;t know though when this will be available for use; it&rsquo;s not even in beta yet.</p>

<p>Well, there you have it. If you weren&rsquo;t at the keynote, now it&rsquo;s as if you were.  :&ndash;)</p>

<p>I&rsquo;ll post more as the conference progresses. Here&rsquo;s <a href="http://greybeardedgeek.net/?p=66">another post</a> on the same keynote.</p>

<p>[Update: Here&rsquo;s <a href="http://www.infoq.com/news/2008/12/springone-2008">a related InfoQ article</a>.]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/27/springone-americas-2008/">SpringOne Americas 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-27T15:37:58-08:00" pubdate data-updated="true">Nov 27<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ll be at <a href="http://americas.springone.com/conference/hollywood/2008/12/index.html">SpringOne Americas 2008</a> this week. Check this space for information about the conference as it unfolds.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/25/publish-an-rss-feed-with-spring-3-0/">Publish an RSS Feed With Spring 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-25T06:27:00-08:00" pubdate data-updated="true">Nov 25<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At the time of this writing, Spring 3.0 isn&rsquo;t out yet, but that doesn&rsquo;t mean we can&rsquo;t start goofing around with the <a href="http://static.springframework.org/downloads/nightly/snapshot-download.php?project=SPR">nightly snapshots</a>. I&rsquo;ve been doing just that, and in this article I&rsquo;ll show you how to publish an RSS feed using the new <code>AbstractRssFeedView</code> class from Spring 3.0.</p>

<p>Those familiar with <a href="https://springmodules.dev.java.net/">Spring Modules</a> might recognize our view class. It began life as <code>AbstractRssView</code> in the Spring Modules project. But as of Spring 3.0, it&rsquo;s now a first-class member of the framework (though it&rsquo;s been renamed to <code>AbstractRssFeedView</code>), along with the <code>AbstractAtomFeedView</code> class for Atom feeds, and the <code>AbstractFeedView</code>, which serves as a base class for both. The new classes, like the old one, are based on Sun&rsquo;s <a href="https://rome.dev.java.net/">ROME API</a>.</p>

<p>You&rsquo;ll need to know Spring Web MVC to get the most out of this article. In particular, you&rsquo;ll need to understand the relationship between controllers and views, which in a nutshell is this: when a controller is done processing a request, it returns a logical view name that a view resolver subsequently maps to a view.</p>

<p>Without further ado, let&rsquo;s look at some code.</p>

<h3>The controller</h3>


<p>Let&rsquo;s start with the controller, since processing starts there, and since that&rsquo;s probably more familiar to more readers than implementing views. Here&rsquo;s a pretty basic controller for a news feed.</p>

<pre>package rssdemo.web;

import javax.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Required;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import rssdemo.model.NewsItem;
import rssdemo.service.NewsService;

@Controller
public final class NewsController {
    private NewsService newsService;
    private String rssNewsFeedView;
    
    @Required
    public void setNewsService(NewsService newsService) {
        this.newsService = newsService;
    }
    
    @Required
    public void setRssNewsFeedView(String rssNewsFeedView) {
        this.rssNewsFeedView = rssNewsFeedView;
    }
    
    @RequestMapping("/news.rss")
    public String rss(HttpServletResponse res, Model model) {
        List&lt;NewsItem&gt; newsItems = newsService.getAllNewsItems();
        model.addAttribute(newsItems);                                     // 1
        return rssNewsFeedView;                                            // 2
    }
}
</pre>


<p>As you can see, this controller really is as simple as I said it would be. Our <code>rss()</code> method grabs a list of <code>NewsItem</code>s from the <code>NewsService</code> <span class="cueball">1</span> and places it on the <code>Model</code> under a conventionally-generated key, which in this case would be <code>newsItemList</code>. Then we simply return an injected logical view name <span class="cueball">2</span>, which we&rsquo;re going to map to an actual view shortly. (We inject the view name to maintain the separation between the controller and the view.)</p>

<p>Now let&rsquo;s check out the star of the show, which would be our view.</p>

<h3>The view, via Spring 3.0&#8217;s new AbstractRssFeedView</h3>


<p>Now we come to the meat of the subject. Here we&rsquo;re going to implement a Spring Web MVC view by extending Spring 3.0&rsquo;s new <code>AbstractRssFeedView</code> class and by using ROME to model our news feed. Once we have the view in place, we&rsquo;ll be ready to configure the mapping from the logical view name we set in the controller to the view.</p>

<p>The next listing what&rsquo;s involved in implementing a view for an RSS feed. If you&rsquo;re doing an Atom feed, the approach is entirely analogous, but you would just need to extend <code>AbstractAtomFeedView</code> instead of <code>AbstractRssFeedView</code>.</p>

<pre>package rssdemo.web;

import java.util.*;
import javax.servlet.http.*;
import org.springframework.beans.factory.annotation.Required;
import org.springframework.web.servlet.view.feed.AbstractRssFeedView;
import com.sun.syndication.feed.rss.Channel;
import com.sun.syndication.feed.rss.Description;
import com.sun.syndication.feed.rss.Item;
import rssdemo.model.NewsItem;

public final class RssNewsFeedView extends AbstractRssFeedView {           // 1
    private String feedTitle;                                              // 2
    private String feedDesc;
    private String feedLink;
    
    @Required
    public void setFeedTitle(String feedTitle) {
        this.feedTitle = feedTitle;
    }
    
    @Required
    public void setFeedDescription(String feedDesc) {
        this.feedDesc = feedDesc;
    }
    
    @Required
    public void setFeedLink(String feedLink) {
        this.feedLink = feedLink;
    }

    @Override
    protected void buildFeedMetadata(
            Map model, Channel feed, HttpServletRequest request) {         // 3
        
        feed.setTitle(feedTitle);
        feed.setDescription(feedDesc);
        feed.setLink(feedLink);
    }
    
    @Override
    protected List&lt;Item&gt; buildFeedItems(
            Map model,
            HttpServletRequest request,
            HttpServletResponse response)
        throws Exception {                                                 // 4
        
        @SuppressWarnings("unchecked")
        List&lt;NewsItem&gt; newsItems =
            (List&lt;NewsItem&gt;) model.get("newsItemList");                    // 5
        
        List&lt;Item&gt; feedItems = new ArrayList&lt;Item&gt;();
        for (NewsItem newsItem : newsItems) {                              // 6
            Item feedItem = new Item();
            feedItem.setTitle(newsItem.getTitle());
            feedItem.setAuthor(newsItem.getAuthor());
            feedItem.setPubDate(newsItem.getDatePublished());
            
            Description desc = new Description();
            desc.setType("text/html");
            desc.setValue(newsItem.getDescription());
            feedItem.setDescription(desc);
            
            feedItem.setLink(newsItem.getLink());
            feedItems.add(feedItem);
        }
        
        return feedItems;
    }
}</pre>


<p>So what&rsquo;s going on here? Well, we begin by extending the <code>AbstractRssFeedView</code> class <span class="cueball">1</span>. Then we include some injected fields for feed metadata <span class="cueball">2</span>. We use these in the optional <code>buildFeedMetadata()</code> method <span class="cueball">3</span>. I say &ldquo;optional&rdquo; because the <code>AbstractRssFeedView</code> provides a dummy implementation (actually, its superclass <code>AbstractFeedView</code> provides it).</p>

<p>The method we&rsquo;re required to implement is <code>buildFeedItems()</code> <span class="cueball">4</span>. Here&rsquo;s where we map our list of domain objects (here, a list of <code>NewsItem</code> objects that are just something we cooked up ourselves) to the ROME API, which provides a structure for modeling feeds. We begin by grabbing the <code>NewsItem</code> list off the model (recall from listing 1 that we placed the list on the model in the controller) <span class="cueball">5</span>. Then we iterate over the <code>NewsItem</code> list, mapping each one to a ROME <code>Item</code> <span class="cueball">6</span>.</p>

<p>That should be pretty straightforward-looking. And we&rsquo;re almost done. There&rsquo;s just one part that remains, and that&rsquo;s establishing the mapping between the logical view name we return from the controller and the <code>RssNewsFeedView</code> that we just created. We do that in the application context.</p>

<h3>Configure the view resolver for your RSS feed</h3>


<p>The last thing we need to take care of is configuring up the right view resolver in our application context. We can&rsquo;t use the standard <code>InternalResourceViewResolver</code> here because we&rsquo;re not mapping to a URL; instead we want to map to a view (namely, the <code>RssNewsFeedView</code> that we just created) and we want that view to handle generating the output directly.</p>

<p>The simplest approach here is to use something called the <code>BeanNameViewResolver</code>. The idea with this type of resolver is quite simple. Whenever a controller returns a logical view name, the <code>BeanNameViewResolver</code> will attempt to find a bean on the application context with the same name (or ID). If there&rsquo;s a match, then it interprets that bean as the mapped view. Otherwise, the other resolvers are given their shot at matching the view name.</p>

<p>To add a <code>BeanNameViewResolver</code>, all we need to add is this:</p>

<pre>&lt;bean class="org.springframework.web.servlet.view.BeanNameViewResolver"/&gt;</pre>


<p>We also need to inject the view name into our controller, as we saw in listing 1. Here&rsquo;s how we can do that:</p>

<pre>&lt;bean class="rssdemo.web.NewsController"
    p:newsService-ref="newsService"
    p:rssNewsFeedView="rssNewsFeedView"/&gt;</pre>


<p>We just chose the name <code>rssNewsFeedView</code> more or less arbitrarily; we could have chosen anything. It&rsquo;s good to choose something accurate and descriptive just to keep things clear and the minimize the chance of a mapping conflict, since the name you choose is going to be a bean name. Speaking of which, we&rsquo;ll need to put our view on the app context too:</p>

<pre>&lt;bean id="rssNewsFeedView"
    class="rssdemo.web.RssNewsFeedView"
    p:feedTitle="Ye Olde Cigar Shoppe"
    p:feedDescription="Latest and greatest news about cigars"
    p:feedLink="http://yeoldecigarshoppe.com/"/&gt;</pre>


<p>And there you have it! When the <code>DispatcherServlet</code> gets a request for the RSS feed, it will run the controller method and then grab the resulting view name, which we&rsquo;ve configured to be <code>rssNewsFeedView</code>. Then the <code>BeanNameViewResolver</code> will find the corresponding view bean on the app context&mdash;in this case our <code>RssNewsFeedView</code>&mdash;and the view bean will finish up the request as required. All in all a nice, clean way of handling feed publication.</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/15/aop-101-speeding-up-springs-javamailsenderimpl-with-aop/">AOP 101: Speeding Up Spring&#8217;s JavaMailSenderImpl With AOP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-15T10:40:35-08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="alert info">This material is based on an earlier version of <a href="http://www.manning.com/wheeler/">Spring in Practice, chapter 8</a>&mdash;one that predates the <code>@Async</code> annotation. Nowadays I would recommend using <code>@Async</code> and the Spring Task Execution API for making JavaMail calls asynchonous. The book covers the newer approach. The material in this post is still useful for understanding what you can do with AOP though.</div>


<p>In this article we&rsquo;ll learn how we can speed up Spring&rsquo;s <code>JavaMailSenderImpl</code> with some thread-forking AOP. Though we&rsquo;re using JavaMail as an example, this tutorial should be useful to people looking for a code-based introduction to Spring&rsquo;s support for AOP. Note at the outset that I don&rsquo;t really go into AOP concepts and terminology, but I do show some simple code that you should be able to follow if you already know the basic concepts and just want to see what the code looks like.</p>

<p>There are lots of situations in which we want our application to send out an automated e-mail. You might for instance want to send a confirmation e-mail in response to new user registrations or mailing list subscriptions and unsubscriptions. In Spring this probably means that you would use one of the various <code>JavaMailSenderImpl.send()</code> methods. Here&rsquo;s a sample <code>applicationContext.xml</code> file.</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:jee="http://www.springframework.org/schema/jee"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd&gt;
    
    &lt;jee:jndi-lookup id="mailSession" jndi-name="mail/Session" resource-ref="true"/&gt;
    
    &lt;bean id="mailSender"
        class="org.springframework.mail.javamail.JavaMailSenderImpl"
        p:session-ref="mailSession"/&gt;
    
    &lt;bean id="mailingListService"
        class="app.service.MailingListServiceImpl"
        p:mailSender-ref="mailSender"/&gt;
        
    ...
    
&lt;/beans&gt;</pre>


<p>Here&rsquo;s how it looks from the Java side:</p>

<pre>package app.service;

... imports ...

public class MailingListServiceImpl implements MailingListService {
    private JavaMailSender mailSender;
    
    public void setMailSender(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }
    
    private void sendConfirmSubscriptionEmail(Subscriber subscriber) {
        MimeMessage message = mailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message);
        
        String text = ...
        
        try {
            helper.setSubject("Please confirm your subscription");
            helper.setTo(subscriber.getEmail());
            helper.setFrom(noReplyEmailAddress);
            helper.setSentDate(subscriber.getDateCreated());
            helper.setText(text, true);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        }
        
        mailSender.send(message);
    }
    
    ...
}</pre>


<p>(For more information on Spring/JavaMail integration, please see my article <a href="#">Send E-mail Using Spring and JavaMail</a>.)</p>

<p>This works fine, but one thing your end users might notice is a fairly significant delay while <code>JavaMailSenderImpl.send()</code> does whatever it&rsquo;s doing to send your e-mail (presumably <a href="http://springinpractice.com/2008/05/05/smtp-and-smtp-auth/">negotiating with the SMTP server and sending the actual e-mail</a>). While the delay probably isn&rsquo;t large enough to provoke rioting in the streets, it&rsquo;s certainly noticeable, and in many use cases it&rsquo;s unnecessary. E-mail is itself an asynchronous communications medium, so unless there&rsquo;s an important reason to let the end user know about errors that may occur while trying to send the e-mail (and there may be), one option you might consider is making the <code>send()</code> call on a separate thread.</p>

<p>Now let&rsquo;s look at a few different ways to do that.</p>

<h3>Method 1: Spawn a new thread manually</h3>


<p>One possibility would be to spawn a new thread manually whenever you want to call <code>JavaMailSenderImpl.send()</code>. In other words, you implement the <code>Runnable</code> interface with a call to <code>send()</code>, you pass it into a <code>Thread</code>, and then you start the thread.</p>

<p>This technique has some advantages. It&rsquo;s conceptually straightforward. Also it&rsquo;s easy to be selective about the cases in which you do and don&rsquo;t want to fork. Again, there may well be times where you want the end user to know if the <code>send()</code> call generated an exception, and if that&rsquo;s true, then you simply refrain from forking the thread.</p>

<p>If you&rsquo;re not careful, the approach can lead to widespread violation of the <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY principle</a>. You might end up rewriting the same thread-forking code every time you send an e-mail. You can of course control this by creating one or more utility methods to send an e-mail on a separate thread, and that is a good approach.</p>

<p>One drawback with this approach, though, is that it may be either inconvenient or else a non-option. If you have an existing app with lots of calls to create e-mail, then you&rsquo;d need to update all the instances of that code with the new code. In most cases that&rsquo;s probably doable though it may be inconvenient. But it may be that you&rsquo;re not in a position to change the client code. (Maybe it&rsquo;s a third-party library, for instance.) The client code calls an injected <code>JavaMailSender</code> instance, say, and that&rsquo;s the way it is. In that event you&rsquo;ll want to consider one of the two following alternative methods.</p>

<h3>Method 2: Create a JavaMailSender wrapper</h3>


<p>Another method would be to implement a <code>JavaMailSender</code> wrapper. (<code>JavaMailSender</code> is of course the interface to which <code>JavaMailSenderImpl</code> conforms.) The <code>JavaMailSender</code> interface has six different <code>send()</code> methods (<a href="http://static.springframework.org/spring/docs/2.5.6/api/org/springframework/mail/javamail/JavaMailSender.html">here are the Javadocs</a>), and so you can just implement the thread-forking code for each of the six methods. (Probably each method would create a <code>Runnable</code> and then pass that to a thread-forking utility method.) Then you inject your wrapper into your service beans instead of injecting the <code>JavaMailSenderImpl</code> bean directly.</p>

<p>This approach is pretty good. It&rsquo;s still straightforward, and it allows you to avoid violating DRY. Also, because it&rsquo;s entirely transparent to client code, it can deal with cases in which you either can&rsquo;t or else don&rsquo;t want to modify said client code.</p>

<p>One possible challenge is that you may find it a little tough to exercise fine-grained control over the cases in which you use the wrapper and the cases in which you don&rsquo;t. If it&rsquo;s important for your code to exercise that kind of control, then arguably it would be reasonable to associate the forking/non-forking semantics injected <code>JavaMailSender</code> beans. You might for example inject two <code>JavaMailSender</code> instances into the service bean&mdash;one forking and one non-forking.</p>

<p>A minor grumble about the wrapper method is that it ties the thread-forking behavior to specific interfaces, such as <code>JavaMailSender</code>. That&rsquo;s not too big a deal in this particular case, since it&rsquo;s not such a problem to spawn a new thread. But if you have other cases where you decide you want to create a new thread, you might decide that you&rsquo;d like to factor thread-forking out as a separate behavior and be able to apply that in multiple contexts.</p>

<p>So let&rsquo;s see how to do that using Spring&rsquo;s support for AspectJ-flavored AOP.</p>

<h3>Method 3: Use AOP to wrap JavaMailSenderImpl.send()</h3>


<p>This is a fun and elegant method. Even though this article is called &ldquo;AOP 101&rdquo;, I&rsquo;m not planning to explain the concepts or weird terminology; rather I just want to show you the code and assume that you&rsquo;ll be able to see what&rsquo;s happening.</p>

<p>First we need to create an &ldquo;advice&rdquo; class. This is the code that we&rsquo;re going to wrap around our <code>send()</code> invocations.</p>

<pre>package app.aop;

import org.apache.log4j.Logger;
import org.aspectj.lang.ProceedingJoinPoint;

public class ForkAdvice {
    private static final Logger log = Logger.getLogger(ForkAdvice.class);
    
    public void fork(final ProceedingJoinPoint pjp) {
        new Thread(new Runnable() {
            public void run() {
                log.info("Forking method execution: " + pjp);
                try {
                    pjp.proceed();
                } catch (Throwable t) {
                    // All we can do is log the error.
                    log.error(t);
                }
            }
        }).start();
    }
}</pre>


<p>The fork method is &ldquo;around&rdquo; advice that we&rsquo;re going to use to advise our calls to <code>JavaMailSenderImpl.send()</code>. As you can see, it creates a new thread and starts it. In the <code>run()</code> body, we simply execute the advised method by calling <code>pjp.proceed()</code>.</p>

<p>As an aside, the <code>ProceedingJoinPoint</code> class is provided by the AspectJ class library, but note that we&rsquo;re not using full-blown AspectJ here&mdash;we&rsquo;re in fact using Spring AOP. Full AspectJ involves a special aspect language and compiler to generate classes with the advice woven into the class bytecode itself. Spring AOP on the other hand uses dynamic proxies (either the interface variety that comes with Java, or else class proxies via CGLIB) to advise classes. While Spring AOP borrows classes and also the AspectJ pointcut language from AspectJ, its use of dynamic (runtime) proxies as opposed to bytecode-level advice integration distinguishes it from AspectJ.</p>

<p>Now it&rsquo;s time to update our application context with our AOP configuration.</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:jee="http://www.springframework.org/schema/jee"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd&gt;
    
    &lt;jee:jndi-lookup id="mailSession" jndi-name="mail/Session" resource-ref="true"/&gt;
    
    &lt;bean id="mailSender"
        class="org.springframework.mail.javamail.JavaMailSenderImpl"
        p:session-ref="mailSession"/&gt;
    
    &lt;bean id="mailingListService"
        class="app.service.MailingListServiceImpl"
        p:mailSender-ref="mailSender"/&gt;
        
    &lt;bean id="forkAdvice" class="app.aop.ForkAdvice"/&gt;
    
    &lt;aop:config&gt;
        &lt;aop:aspect ref="forkAdvice"&gt;
            &lt;aop:around method="fork"
pointcut="execution(* org.springframework.mail.javamail.JavaMailSenderImpl.send(..))"/&gt;
        &lt;/aop:aspect&gt;
    &lt;/aop:config&gt;
    
    ...
    
&lt;/beans&gt;</pre>


<p>This is similar to what we had before, but there are a couple of differences. First, note that we&rsquo;ve declared the <code>aop</code> namespace here. That of course allows us to use the namespace configuration feature that Spring 2.0 introduced. The other change is that we&rsquo;ve added a definition for our advice bean as well as some AOP configuration. In <code>aop:aspect</code> we point to our <code>forkAdvice</code> as the advising class to be applied, we indicate that it will be &ldquo;around&rdquo; advice, we specify the advising method, and finally we specify a pointcut that indicates which method calls will be advised/wrapped. We use the <a href="http://www.eclipse.org/aspectj/doc/released/progguide/semantics-pointcuts.html">AspectJ pointcut language</a> to specify a pointcut. Here we&rsquo;re indicating that we want all calls to any of the <code>JavaMailSenderImpl.send()</code> methods to be advised.</p>

<p>As mentioned previously, this technique is like the wrapper technique in that you can use it to add the forking behavior in a way that&rsquo;s transparent to client code. Moreover you can use it not just for JavaMail but really for any method where you want to create a new thread before executing the method. You just add the appropriate <code>aop:around</code> definitions to the <code>aop:aspect</code> definition and you&rsquo;re in business.</p>

<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/27/spring-paranoia-with-initializingbean-and-assert/">Spring Paranoia With InitializingBean and Assert</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-27T07:51:40-07:00" pubdate data-updated="true">Oct 27<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this quick post, I&rsquo;m going to show you how to use the <code>InitializingBean</code> interface and the <code>Assert</code> utility class, both part of the Spring Framework, to express any deep-seated feelings of initialization paranoia you may have.</p>

<p>Let&rsquo;s just jump right in with a code example.</p>

<pre>package com.example.user.service;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.util.Assert;

import com.example.user.dao.UserDao;

public class UserServiceImpl implements UserService, InitializingBean {
    private UserDao userDao;
    private JavaMailSender mailSender;

    public void setUserDao(UserDao userDao) {
        Assert.notNull(userDao, "userDao can't be null"); // 1
        this.userDao = userDao;
    }

    public void setMailSender(JavaMailSender mailSender) {
        Assert.notNull(mailSender, "mailSender can't be null"); // 2
        this.mailSender = mailSender;
    }

    public void afterPropertiesSet() {
        Assert.notNull(userDao, "userDao required"); // 3
        Assert.notNull(mailSender, "mailSender required");
    }

    ...service methods...
}</pre>


<p>In the example above, we have a hypothetical user service with two dependencies: a DAO and a mail sender. The idea here is that we want to do some sanity checks as we initialize our service bean. First, when setting the user DAO, we want to make sure that we don&rsquo;t set it to a null value <span class="cueball">1</span>. We conduct the same test for the mail sender <span class="cueball">2</span>. In each case we use the Spring <code>Assert</code> utility class to perform the test. (Be sure not to confuse this with the <code>assert</code> keyword from the Java language, or the JUnit class of the same name.)</p>

<p>Finally, we implement the single method required by the <code>InitializingBean</code> interface, <code>afterPropertiesSet</code>. Here we check to see that all required properties have actually been set <span class="cueball">3</span>. If they haven&rsquo;t, then Spring complains. Compliant <code>BeanFactory</code> implementations call the <code>afterPropertiesSet</code> method as part of the standard bean lifecycle; see the <a href="http://static.springframework.org/spring/docs/2.5.5/api/org/springframework/beans/factory/BeanFactory.html">BeanFactory Javadocs</a> for more information.</p>

<p>This technique is handy for being sure that your dependency injections actually happen. This is especially useful when using autowiring, where it&rsquo;s easy to miss the fact that some required injection didn&rsquo;t actually occur.</p>

<p>You can use <code>InitializingBean</code> and <code>Assert</code> for any Spring-managed bean, not just service beans. I&rsquo;ve just used a service bean here as an example.</p>

<p>Obviously, if you use the <code>InitializingBean</code> interface then you tie your bean APIs to the Spring Framework. You&rsquo;ll have to decide whether that&rsquo;s something you can live with. With <code>Assert</code>, on the other hand, you&rsquo;re only building in an implementation dependency on Spring, which is less objectionable. (It may still be a minor nuisance if you were to decide to move away from Spring, but nothing you couldn&rsquo;t easily handle. I&rsquo;d probably say the same thing of using <code>InitializingBean</code> in this case, incidentally.)</p>

<p>Anyway, now you know the pros and cons of the approach. Have fun!</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Concurrent Programming for Practicing Software Engineers, Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-15T09:06:02-07:00" pubdate data-updated="true">Oct 15<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>


<p>This third and final post in our series on concurrency explains how synchronization mistakes can lead to the problem of deadlocks, and what you can do to minimize or eliminate them.</p>

<h3>How synchronization gives rise to deadlocks</h3>


<p>We saw in the <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">previous post</a> how a thread will grab a lock just before entering a critical section, thereby forcing other threads to &ldquo;block&rdquo; (concurrency lingo for &ldquo;wait for another thread to release a lock&rdquo;) until they can acquire the lock. Normally this blocking behavior is unremarkable. It is a standard part of concurrent programming since we&rsquo;re trying to protect data from data races.</p>

<p>If there&rsquo;s too much contention for locks, that can of course have a negative effect on performance since threads are sitting around waiting instead of doing work. But usually this just means subpar performance rather than hanging.</p>

<p>The pathological case of contention for locks is <em>deadlocking</em>. This is characterized by two or more threads becoming permanently hung. They are notoriously difficult to predict, avoid and handle, but it&rsquo;s not impossible. The secret to understanding deadlocks is to understand that they arise when threads wait for each other to release a lock in a cyclic fashion. The simplest case would be thread T<sub>1</sub> waiting for T<sub>2</sub> to release a lock, and T<sub>2</sub> waiting for T<sub>1</sub> to release a lock. Neither one can make forward progress. The next simplest case is T<sub>1</sub> waiting for T<sub>2</sub>, T<sub>2</sub> waiting for T<sub>3</sub>, and T<sub>3</sub> waiting for T<sub>1</sub>. Now we have three deadlocked threads. Obviously the cycle can be of arbitrary length; all threads involved will be deadlocked.</p>

<p>Here&rsquo;s a diagram that shows how it works:</p>

<div style="margin: 20px auto; width: 584px;">
    <div><img src="http://wheelersoftware.s3.amazonaws.com/articles/concurrent-programming/deadlocks.jpg" alt="The cyclic nature of deadlocks" /></div>
    <div class="caption"><span class="figure-label">Figure 1.</span> Deadlocks arise from circular dependencies between threads.</div>
</div>


<p>In figure 1, you can see that each thread holds the lock needed by the preceding thread. As the dependencies are circular, there is no way for any of the threads to make forward progress once something like the above happens. All five threads are hung&mdash;that is, deadlocked.</p>

<div style="margin-right: 10px; float: left">
    <div><img src="http://wheelersoftware.s3.amazonaws.com/articles/concurrent-programming/vambrace-m16.jpg" alt="" /></div>
    <div class="photo-caption" style="text-align: center">Photo credit: <a href="http://www.flickr.com/photos/gladius/2296372699/">gladius</a></div>
</div>




<h4>A furry aside</h4>


<p>By now you might understand what I meant at the beginning of the article when I said that concurrent programming is kind of like an arms race. We start with single threads, but sometimes that&rsquo;s too slow, so we introduce multithreading. That causes a problem though, which is that the threads can interfere with one another when working with shared data. So we introduce turn-taking through mutexes (and through the <code>synchronized</code> keyword in particular). But that has the effect of limiting parallelism, and if we take that too far, we can end up sacrificing the parallelism (and performance) that we sought in the first place. In the most extreme case, we can inadvertently cause threads to deadlock.</p>

<p>(Maybe <a href="http://en.wikipedia.org/wiki/Whac-a-mole">Whac-A-Mole</a> is a better metaphor. That&rsquo;s OK. I&rsquo;m going to stick with arms race just because I really like the mech/cyber photo. Think of it as an arms race between software engineers and small furry rodents.)</p>

<div style="clear: both"></div>


<p>Now let&rsquo;s consider an example of code vulnerable to deadlocks.</p>

<h4>Some deadlocky code</h4>


<p>For this one we&rsquo;re going to use the standard bank account funds transfer example. Yes, it&rsquo;s a clich&egrave;d example, but it&rsquo;s such a good example and originality is overrated anyway. Here&rsquo;s listing 3:</p>

<div>
    <div><span class="code-listing">Listing 3.</span> A deadlock just waiting to happen</div>
        <pre>public void transferFunds(Account from, Account to, Money amount) {
    synchronized (from) {
        synchronized (to) {
            from.decreaseBy(amount);
            to.increaseBy(amount);
        }
    }
}</pre>
</div>


<p>(We&rsquo;ll ignore exceptional conditions such as insufficient funds. Or, if you like, assume that <code>decreaseBy()</code> throws an unchecked <code>InsufficientFundsException</code>.)</p>

<p>If it isn&rsquo;t obvious, the method is a service method that transfers funds from one account to another account. Before going further, take a look at the code and see if you can figure out how the deadlock can occur. Keep in mind what we said about cyclic dependencies.</p>

<h4>Here&#8217;s how a deadlock can occur</h4>


<p>Recall from the discussion above that deadlocks involve multiple threads. Each one grabs a lock that one of the other threads needs, and needs a lock that one of the other threads has. Here, we have two <code>synchronized</code> blocks, and each entry point corresponds to a place where a thread will try to grab a lock, maybe successfully and maybe not.</p>

<p>With that information it&rsquo;s straightforward to construct the sequence of events that leads to the deadlock:</p>

<ol>

<li>Thread T<sub>1</sub> enters the method, with the source account being account 4 and the destination account being account 14. T<sub>1</sub> is able to acquire the lock for account 4, but then there&#8217;s a context switch before it can enter the second <code>synchronized</code> block.</li>

<li>Thread T<sub>2</sub> also enters the method, with the source account being account 14 and the destination account being account 4. T<sub>2</sub> is able to acquire the lock for account 14, but then gets blocked when trying to acquire the lock for account 4. That stands to reason, since T<sub>1</sub> has it. Context switch.</li>

<li>T<sub>1</sub> tries to grab the lock for account 14, but of course it can&#8217;t since T<sub>2</sub> has it. Threads T<sub>1</sub> and T<sub>2</sub> are now deadlocked.</li>

</ol>


<p>That&rsquo;s a fairly intricate bit of logic, and developers new to concurrent programming may wonder how in the heck they are supposed to anticipate problems like that. They may also wonder whether this series of events is so implausible that is just isn&rsquo;t worth worrying about. To answer the second concern first, deadlocks most certainly do occur in real code. Keep in mind that although the situations that produce them may be implausible, the problem is that CPU clock speeds are pretty incredible, and so things that seem implausible suddenly become just a matter of time.</p>

<p>As to how to defend against deadlocks, we&rsquo;ll look at that right now.</p>

<h3>Solving deadlocks with globally-defined lock orderings</h3>


<p>There are different ways to either minimize the likelihood of deadlocking or else just avoid it altogether. One best practice is to minimize the scope of your critical sections so as to decrease the time that threads hang onto locks, and hence to decrease the likelihood of a deadlock. That however doesn&rsquo;t solve the issue; deadlocks can still occur.</p>

<p>Another technique is to avoid the sort of nested locking that we saw in the example in the previous page. Instead of locking each account individually, we might define a single lock that any thread must acquire before doing a transfer. While this does indeed eliminate deadlocks, it does so at a very steep cost: acquiring the single lock becomes a bottleneck, and limits the parallelism we&rsquo;re trying to achieve in the first place. It does not scale.</p>

<p>A third technique is to use timeouts. Under this approach, if any thread is blocked for a sufficiently lengthy period of time, it just gives up.</p>

<p>Those are all legitimate techniques, but in this section we&rsquo;ll discuss global lock orders.</p>

<h4>What is a globally-defined lock order?</h4>


<p>Recall in our discussion of deadlocks that they arise from circular dependencies between the threads. Any given thread depends on a resource (a lock) that the previous thread in the ring holds. So one way to stamp out deadlocks is to define a global ordering on the locks so that such cycles can never arise. In other words, you define and publish rules around which locks to acquire before which other locks. This approach requires significant discipline from developers since there isn&rsquo;t any automatic way to enforce it. It is however extremely useful since it makes deadlocks impossible.</p>

<p>Let&rsquo;s see how we might apply a global lock order to the funds transfer example.</p>

<h4>The funds transfer example reconsidered</h4>


<p>At first glance you might think, &ldquo;Wait a minute. The source account&rsquo;s lock is always grabbed before the destination account&rsquo;s lock, so how is it possible for a deadlock to occur?&rdquo; But upon closer examination it&rsquo;s clear that that&rsquo;s not a correct analysis. Whatever global lock order we define needs to translate ultimately down to instances, not roles in a transaction. Sometimes account 4 will be the source account, and sometimes it will be the destination account. Similarly for account 14. Whatever global lock order we define needs to handle that.</p>

<p>One straightforward way to define a lock order for our current example would be to say that we always grab the lock for the account with the lower ID first. Listing 4 shows the new code:</p>

<div>
    <div><span class="code-listing">Listing 4.</span> Applying a globally-defined lock order</div>
    <pre>public void transferFunds(Account from, Account to, Money amount) {
    long fromId = from.getId();
    long toId = to.getId();
    long lowId = (fromId &lt; toId ? fromId : toId);
    long highId = (fromId &lt; toId ? toId : fromId);
    synchronized (lowId) {
        synchronized (highId) {
            from.decreaseBy(amount);
            to.increaseBy(amount);
        }
    }
}</pre>
</div>


<p>The code above is deadlock-free, because cyclic dependencies are impossible. Say thread T<sub>1</sub> wants to transfer funds from account 4 to account 14, and thread T<sub>2</sub> wants to transfer funds from account 14 to account 4. Both threads will try to grab the lock for account 4 before trying to grab the lock for account 14. Thus it&rsquo;s impossible to wait for the lock on account 4 while holding the lock for account 14, at least as long as all code observes the same globally-defined lock ordering that we&rsquo;ve observed here. (Hence &ldquo;global&rdquo;.)</p>

<h3>Conclusion and recommended readings</h3>


<p>In this series we looked at several key areas of concurrent programming that (in my opinion, anyway) all practicing software developers should understand. As regards concurrency, there is a gap between what typical developers <em>should</em> know and what they <em>actually</em> know, and that causes real-world production issues on a regular basis. I wrote this series to try to narrow that gap.</p>

<p>There are of course lots of good resources for concurrent programming. Here are some of my favorites:</p>

<ul class="square">

<li><a href="http://www.infoq.com/presentations/goetz-concurrency-past-present">Concurrency: Past and Present</a>, by Brian Goetz: An entertaining presentation on concurrency. Goetz is a well-known authority on concurrent programming.</li>

<li><a href="http://jcip.net/">Java Concurrency in Practice</a>, by Brian Goetz. A really great and approachable book.</li>

<li><a href="http://www.amazon.com/Concurrent-Programming-Java-TM-Principles/dp/0201310090">Concurrent Programming in Java(TM): Design Principles and Pattern (2nd Edition)</a>, by Doug Lea. Another great book on concurrency; probably the standard. More academic than the Goetz book but still quite approachable.</li>

<li><a href="http://sunnyday.mit.edu/papers/therac.pdf">The Therac-25 Accidents</a>: A classic software engineering paper on how race conditions actually injured and killed people. The basic idea is that the Therac-25 machine, which was designed to administer radiation to cancer patients, was vulnerable to race conditions that occurred as the human operator became more experienced with operating the machine (and thus keyboarded commands more quickly). The race conditions led to massive radiation overdoses. Long but well worth the read.</li>

</ul>




<div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>




<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Concurrent Programming for Practicing Software Engineers, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-14T08:44:32-07:00" pubdate data-updated="true">Oct 14<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>


<p>This post is the second in a three-part series on concurrent programming. In the <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">first post</a> we learned some basic concepts such as threads and serial vs. parallel execution. In this post we&rsquo;ll learn how parallel execution can create problems if we&rsquo;re not careful.</p>

<h3>How parallelism gives rise to race conditions</h3>


<p>Even among parallelizable problems, some are harder than others. The easy ones are the ones that don&rsquo;t involve threads sharing state with one another. For example, if you have five independent work queues, and the goal is simply to process all the tasks in all the queues, then there&rsquo;s nothing especially tough about this. You start five threads, run them against the five queues, and then move on once they&rsquo;re done.</p>

<p>The trickier problems are the ones that involve threads sharing state with one another. Let&rsquo;s see why.</p>

<h4>Threads and shared state</h4>


<p>Shared state presents a challenge in concurrent programming because threads can interfere with one another if their access to that shared state isn&rsquo;t properly coordinated. If you&rsquo;ve ever tried to collaborate with other authors on a single document, you might have some experience with this problem. (Though Google Docs does a nice job of supporting multiple simultaneous authors.) You make some changes to the document, hoping that your coauthor didn&rsquo;t make his own changes to the part that you worked on. If he did, then there may be a mess to clean up.</p>

<p>The essence of the problem is that at least one guy is updating the document while somebody else is either reading it or writing it. We talked about the case where you have two authors writing to the document, but it can be one guy writing and someone else reading. If one person is in the middle of updating emergency information for hurricane evacuees and another person reads a partial update, the result could be dangerous.</p>

<p>Note that there&rsquo;s no problem if you have a bunch of people simply <em>reading</em> a document at the same time. The problem only comes up if at least one of them is <em>writing</em> to it.</p>

<p>The problem we&rsquo;ve just described is called a <em>race condition</em>. The idea is that if threads aren&rsquo;t properly coordinated, then their concurrent work is vulnerable to problems associated with &ldquo;unlucky timing&rdquo;. There can be situations in which one thread is trying to update shared state and one or more other threads are trying to access it (either read or write). In effect the threads &ldquo;race&rdquo; against one another and the outcome of their work is dependent on the nondeterministic outcome of their race.</p>

<p>Let&rsquo;s look at a code example.</p>

<h4>An example of code that allows race conditions</h4>


<p>Originally I was going to present the standard (and probably a bit tired) web page hit counter example. But then today I saw somebody&rsquo;s purportedly threadsafe class that is in fact susceptible to race conditions. The code was written by an experienced engineer. So let&rsquo;s use that example instead, shown in Listing 1 below, as it&rsquo;s instructive.</p>

<div>
    <div>
        <span class="code-listing">Listing 1.</span> A class that&#8217;s supposed to be threadsafe, but isn&#8217;t
    </div>
    <pre>public class InMemoryUserDao implements UserDao {
    private Map&lt;String, User&gt; users;

    public InMemoryUserDao() {
        users = Collections.synchronizedMap(new HashMap&lt;String, User&gt;());
    }

    public boolean userExists(String username) {
        return users.containsKey(username);
    }

    public void createUser(User user) {
        String username = user.getUsername();
        if (userExists(username)) {
            throw new DuplicateUserException();
        }
        users.put(username, user);
    }

    public User findUser(String username) {
        User user = users.get(username);
        if (user == null) {
            throw new NoSuchUserException();
        }
        return user;
    }

    public void updateUser(User user) {
        String username = user.getUsername();
        if (!userExists(username)) {
            throw new NoSuchUserException();
        }
        users.put(username, user);
    }

    public void removeUser(String username) {
        if (!userExists(username)) {
            throw new NoSuchUserException();
        }
        users.remove(username);
    }
}</pre>
    </div>


<p>What do you think? See anything? The engineer claims that the class is threadsafe because we&rsquo;ve wrapped our hashmap with a synchronized instance.</p>

<h4>Threadsafety problems with the code</h4>


<p>It turns out that that&rsquo;s not correct. It&rsquo;s a common misconception that as long as you&rsquo;re dealing with a threadsafe collection (like a synchronized map), you&rsquo;ve taken care of any threadsafety issues you might have otherwise had. We&rsquo;ll use this example to show why this belief is just plain wrong.</p>

<p>Before I expose the race conditions, let me state some plausible assumptions about the intended semantics for the class:</p>

<ul class="square">
<li>Calling <code>createUser()</code> with an user whose username already exists in the map should generate a <code>DuplicateUserException</code>.</li>
<li>Calling <code>updateUser()</code> with an user whose username does not already exist should generate a <code>NoSuchUserException</code>.</li>
<li>Calling <code>removeUser()</code> with an user whose username does not already exist should generate a <code>NoSuchUserException</code>.</li>
</ul>


<p>Now let&rsquo;s see how the implementation fails to support those semantics, and in particular how the implementation permits race conditions.</p>

<p><b>createUser() is broken.</b> Here&rsquo;s a race that shows that <code>createUser()</code> does not have the intended semantics:</p>

<ol>

<li>Thread T<sub>1</sub> enters <code>createUser()</code>, with argument user U<sub>1</sub> having username N. N is not already in the map.</li>

<li>Thread T<sub>1</sub> successfully makes it past the <code>if</code> test, but not yet to the line that puts N in the map.</li>

<li>Context switch to thread T<sub>2</sub>, which also enters <code>createUser()</code>, this time with argument user U<sub>2</sub> having the same username N that U<sub>1</sub> has. (You can imagine, for example, two users registering with the same username at the same time.) N is still not in the map, because thread T<sub>1</sub> hasn&#8217;t put it there yet.</li>

<li>Thread T<sub>2</sub> completes its call to <code>createUser()</code> and exits. User U<sub>2</sub> and username N are now in the map.</li>

<li>Thread T<sub>1</sub> completes the method and executes. User U<sub>1</sub> has been placed into the map under the key N.</li>

</ol>


<p>Poof! User U<sub>2</sub> simply disappears from the map, having been overwritten by user U<sub>1</sub>. T<sub>1</sub> never encounters the <code>DuplicateUserException</code> it&rsquo;s supposed to encounter.</p>

<p><b>updateUser() is broken.</b> This one is a little more subtle than the <code>createUser()</code> case. Here&rsquo;s the race:</p>

<ol>
<li>Thread T<sub>1</sub> enters <code>updateUser()</code> with user U having name N. The user already exists in the map, so T<sub>1</sub> passes the <code>if</code> test successfully. It hasn&#8217;t reached the <code>put()</code> part yet.</li>
<li>Context switch to thread T<sub>2</sub>, which enters and exits <code>removeUser()</code> with username N (the same one that T<sub>1</sub> was using). The user U is removed from the map.</li>
<li>Thread T<sub>1</sub> completes, placing U back in the map under key N. User U has essentially been reinstated.</li>
</ol>


<p>The problem here is that the <code>removeUser()</code> method completed successfully, there was no <code>createUser()</code> call, and yet there&rsquo;s still a user sitting in the map with no error having been thrown. Given the semantics described above, that should not be possible. The only two possible outcomes ought to be: (1) the update occurs before the remove, which would mean that when the two threads complete, U is no longer in the map; or (2) the remove occurs before the update, which would mean that U should be gone, and the update should have generated an exception. In either case, U should not be in the map when the two threads complete, and yet there it is. So if T<sub>2</sub> belongs to an admin who thought he was removing a troublesome user, guess again.</p>

<p><b>removeUser() is broken.</b> We&rsquo;ve already seen in the race above that there are situations under which <code>removeUser()</code> would be expected to remove a user but does not actually do that. Here&rsquo;s another race for you, probably less significant, but still a bug:</p>

<ol>
<li>Thread T<sub>1</sub> enters <code>removeUser()</code> with existing username N, and makes it past the <code>if</code> test.</li>
<li>Context switch to thread T<sub>2</sub>, which enters and exits <code>removeUser()</code> with the same username N.</li>
<li>Thread T<sub>1</sub> completes and exits the method.</li>
</ol>


<p>In this case we have two methods that called the <code>removeUser()</code> method with the same username, but neither thread encountered a <code>NoSuchUserException</code>. That is not compatible with the semantics of the class.</p>

<p>Now that we&rsquo;ve seen some problems, let&rsquo;s try to understand what&rsquo;s happening here.</p>

<h4>What the three broken methods have in common</h4>


<p>One thing that all three cases have in common is that they follow a &ldquo;check-then-act&rdquo; pattern, where both the &ldquo;check&rdquo; and &ldquo;act&rdquo; parts reference shared data (in this case, the hashmap). The <code>createUser()</code> method checks whether the username already exists, and if not, adds the user to the map. The <code>updateUser()</code> method checks whether the username already exists, and if so, updates the user. <code>removeUser()</code> checks whether the username exists, and if so, deletes the user.</p>

<p>Note that the <code>findUser()</code> method does <em>not</em> follow the same pattern. It does a single <code>get()</code> against the map, and then does a check that checks the returned user rather than checking something against the map. Though it looks like almost the same thing, it is really a completely different situation because we&rsquo;re performing only one action against the shared data instead of multiple actions.</p>

<p>It turns out that the difference between <code>createUser()</code>, <code>updateUser()</code> and <code>removeUser()</code>, on the one hand, and the <code>findUser()</code> method, on the other, is important from a threadsafety point of view. Essentially what&rsquo;s happening is that the <code>findUser()</code> method is <em>atomic</em> (with a certain qualification, which we&rsquo;ll discuss in the next section), meaning that it executes as a single action. The <code>createUser()</code>, <code>updateUser()</code> and <code>removeUser()</code> methods, on the other hand, are not atomic. The various check and act operations can be interleaved in arbitrary ways across different threads. Intuitively what that means is that checks, which are supposed to provide safety, can become invalid because other actions can be scheduled in between any given check-act pair. The safety checks are invalidated and the class behaves in strange ways (especially as load increases, which is usually the most inopportune time for such issues to arise).</p>

<p>Now let&rsquo;s look at how we can solve race conditions such as the ones we&rsquo;ve been considering.</p>

<h3>Solving race conditions with synchronization</h3>


<p>The key to avoiding race conditions is to coordinate the multiple threads when accessing shared data. There are different ways to do this, but the simplest is the one your mom taught you when you were a kid: take turns.</p>

<h4>Taking turns with mutexes</h4>


<p>Here&rsquo;s how you take turns in software. Suppose that you have some shared data that you want to protect, such as a list of all the posts in a given web-based discussion forum, or a web page hit counter. You have various blocks of code throughout your application that access that data, both reading it and writing it. These blocks of code don&rsquo;t have to be in the same class (though they often are), but they&rsquo;re all accessing the same data.</p>

<p>(Keep in mind that when we describe the data as shared data, we mean that it&rsquo;s shared by multiple threads, not that multiple blocks of code access it. If multiple blocks of code access the data but only one thread ever does, then it&rsquo;s not shared data.)</p>

<p>The trick is to protect the code so that only one thread can enter it at a time. I don&rsquo;t mean that only one thread can enter one of the code blocks at a time. I mean that if you consider the whole set of code blocks as a single group, only one thread can enter that group at a time. So if one thread enters one of the blocks, then all other threads need to be kept out of all other blocks until that first thread is done.</p>

<p>The way we enforce this behavior is to associate with each block of code you want to protect something called a mutual exclusion lock, or <em>mutex</em>. People often just call it a lock as well. You associate a lock with any given piece of data you want to protect, and all the code blocks that access that data use that same lock. A thread is not allowed to enter the code block unless it acquires the lock. So whenever thread T<sub>1</sub> wants to enter, it attempts to grab the lock. If the lock is available, then T<sub>1</sub> takes it and other threads have to wait until T<sub>1</sub> is done. If instead some other thread T<sub>2</sub> has the lock, then T<sub>1</sub> has to wait until T<sub>2</sub> is done.</p>

<p>When a thread leaves the block of code protected by the mutex, known as the <em>critical section</em>, it releases the lock.</p>

<p>Incidentally, I always thought it was kind of funny we talk about grabbing locks. It seems like we should say we grab a key so we can get past the lock. But that&rsquo;s not how people talk about it.</p>

<p>We now introduce the principal way of implementing a mutex in Java, the <code>synchronized</code> keyword.</p>

<h4>The <code>synchronized</code> keyword</h4>


<p>In Java the primary mechanism for enforcing turn-taking across threads is the <code>synchronized</code> keyword. You basically put the code you want to protect inside a <code>synchronized</code> block, specifying a lock object (or more exactly, specifying an object whose <em>monitor</em> will be used as a lock&mdash;in Java, each object has a &ldquo;monitor&rdquo; that can be used as a mutex). If you want to synchronize access to the whole method, you just use the <code>synchronized</code> keyword on the method itself. In this latter case, the locking object is the one on which the method is being called.</p>

<p>Here&rsquo;s an example of a synchronized block:</p>

<pre>synchronized (myList) {
    int lastIndex = myList.size() - 1;
    myList.remove(lastIndex);
}</pre>


<p>Here, we&rsquo;re using the <code>myList</code> instance as the lock. Anytime a thread wants to enter this block of code, or any other block of code protected by the same lock, it needs to grab the lock on the <code>myList</code> instance first. And it releases the lock upon exiting the <code>synchronized</code> block (i.e., the critical section).</p>

<p>Here&rsquo;s an example of a synchronized method:</p>

<pre>public class Order {

    ...

    public synchronized void removeLastLineItem() {
        int lastIndex = myList.size() - 1;
        myList.remove(lastIndex);
    }
}</pre>


<p>In this case, a thread wanting to enter the <code>removeLastLineItem()</code> method would need to grab the lock on the relevant <code>Order</code> instance first, and would release the lock after exiting the method.</p>

<p>Armed with our understanding of mutexes and the <code>synchronized</code> keyword, let&rsquo;s revisit our example from the previous page.</p>

<h4>Our example, revisited: making the code threadsafe</h4>


<p>Listing 2 shows how to apply thread synchronization to make the class threadsafe.</p>

<div>
    <div><span class="code-listing">Listing 2.</span> A threadsafe version of our DAO</div>
    <pre>public final class InMemoryUserDao implements UserDao {
    private Map&lt;String, User&gt; users;

    public InMemoryUserDao() {
        users = Collections.synchronizedMap(new HashMap&lt;String, User&gt;());
    }

    public boolean userExists(String username) {
        return users.containsKey(username);
    }

    public void createUser(User user) {
        String username = user.getUsername();
        synchronized (users) {
            if (userExists(username)) {
                throw new DuplicateUserException();
            }
            users.put(username, user);
        }
    }

    public User findUser(String username) {
        User user = users.get(username);
        if (user == null) {
            throw new NoSuchUserException();
        }
        return user;
    }

    public void updateUser(User user) {
        String username = user.getUsername();
        synchronized (users) {
            if (!userExists(username)) {
                throw new NoSuchUserException();
            }
            users.put(username, user);
        }
    }

    public void removeUser(String username) {
        synchronized (users) {
            if (!userExists(username)) {
                throw new NoSuchUserException();
            }
            users.remove(username);
        }
    }
}</pre>
    </div>


<p>In Listing 2 we&rsquo;ve addressed the three issues that we raised earlier. First note that the <code>users</code> instance is entirely encapsulated by our <code>InMemoryUserDao</code> class (I&rsquo;ve made the class <code>final</code> to prevent inheritance from breaking our encapsulation here), so that means it is entirely within our power to protect every possible access to the <code>users</code> instance. (Hm, that&rsquo;s probably a good interview question: &ldquo;Discuss the relationship between encapsulation and threadsafety.&rdquo;)</p>

<p>Next note that we&rsquo;ve addressed the general problem that we saw by making every &ldquo;check-then-act&rdquo; occurrence atomic. Now the code is such that if thread T checks something (such as checking whether a username exists), we can be sure that the answer doesn&rsquo;t change before the action part, because no other thread is able to access the <code>users</code> instance at all until T is done with it.</p>

<h4>Internal vs. external synchronization</h4>


<p>There&rsquo;s one detail to discuss. Take a look at the <code>userExists()</code> and <code>findUser()</code> methods. In both cases we access the <code>users</code> instance, but there&rsquo;s no <code>synchronized</code> block. The reason this isn&rsquo;t a problem is that both of the following are true:</p>

<ol>
<li>we&#8217;re calling only one method on the <code>users</code> map, and</li>
<li>the map is internally synchronized since we created the map using the <code>Collections.synchronizedMap(...)</code> wrapper.</li>
</ol>


<p>If either of those two conditions had failed, we&rsquo;d need to put the calls in a <code>synchronized</code> block. It&rsquo;s useful to discuss these a little more carefully.</p>

<p>Let&rsquo;s take (1) first. Note that even though we don&rsquo;t have an explicit <code>synchronized</code> block, each individual method call we make against <code>users</code> is threadsafe. That&rsquo;s because the <code>users</code> map is internally synchronized on the monitor for the <code>users</code> instance itself. That is, the map handles synchronization for individual method calls so we don&rsquo;t have to. If we&rsquo;re just going to call a single method on an internally synchronized method, we&rsquo;re usually OK to do so.</p>

<p>The place where we have to pay attention to threadsafety is where we call multiple methods on the <code>users</code> instance. There, the internal synchronization doesn&rsquo;t help us at all because that synchronization doesn&rsquo;t prevent the thread from releasing the lock in between the multiple method calls. And when it releases the lock, another thread can come in and change the data. If your code logic assumes that the multiple method calls behave as an atomic unit, you have a problem. Therefore you must provide your own synchronization on the relevant lock when you use check-then-act and similar patterns.</p>

<p>It is a common error to assume that just because the object is internally synchronized, you don&rsquo;t have to worry about threadsafety anymore. That is simply not true, as we&rsquo;ve just explained.</p>

<p>Now take (2). Clearly if the map didn&rsquo;t have any internal synchronization, then we&rsquo;d need to provide it ourselves, even for single method calls against the map. Otherwise threads could get in and muck things up for other threads. This is true even in many cases where it <em>looks</em> like individual threads are performing atomic actions. For example, if you have some threads making <code>get()</code> calls against a <code>HashMap</code>, and another set of threads making <code>put()</code> calls against the same <code>HashMap</code>, you may think that they are all performing atomic operations and therefore it&rsquo;s OK to do this. But that is not correct. The problem is that they only <em>look</em> like atomic operations; behind the scenes, they&rsquo;re impacting the size of a shared backing array, which in turn impacts how hashcodes are mapped to buckets, which impacts the <code>get()</code> and <code>put()</code> calls themselves. If the class had internal synchronization then <code>get()</code> and <code>put()</code> would both be atomic from the perspective of external code, but without that, they aren&rsquo;t atomic at all.</p>

<p>That was your crash course on solving race conditions with thread synchronization. It&rsquo;s not a simple topic, but you should now have the basics. But even though thread synchronization helps solve one problem, unfortunately it creates another. The problem is that in forcing threads to stop and wait their turn, you create the potential for the situation in which threads might wait indefinitely before they can move on. This is called a deadlock, and we&rsquo;ll turn to it in the next post in the series.</p>

<div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>




<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Concurrent Programming for Practicing Software Engineers, Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-13T08:25:07-07:00" pubdate data-updated="true">Oct 13<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>


<p><a href="http://www.flickr.com/photos/12495774@N02/2405297371/"><img src="http://wheelersoftware.s3.amazonaws.com/articles/concurrent-programming/race.jpg" align="right" /></a></p>

<p>Many professional software engineers see concurrent programming as something of an arcane art, and indeed it&rsquo;s possible to make it several years into a career without a good grasp of threads. The reasons seem clear enough:</p>

<ul class="square">

<li>Most problems don&#8217;t require a strong understanding of concurrency. I&#8217;d even argue that many web applications, which are often <em>highly</em> concurrent, don&#8217;t require a strong understanding of concurrency: sometimes there isn&#8217;t significant data sharing; sometimes the burden of managing concurrency, isolation and deadlocks is pushed back to a transactional data store; sometimes the consequences of races are minor or completely insignificant; etc.</li>

<li>Even when a problem does require some knowledge of concurrency, a lack of knowledge manifests itself only sporadically and generally in ways that are difficult to reproduce, which allows people to mistake their 99.9999% solution for a 100% solution. Even in cases where the developer is under no such delusion, he may believe that his 99.9999% solution &#8220;works&#8221;. He fails to notice that 99.9999% may not be so high when you&#8217;re talking about long-running applications running on processors that execute billions of cycles per second, and that sometimes the consequences of that 1-in-1,000,000 screwup are <a href="http://en.wikipedia.org/wiki/Therac-25">disastrous</a>.</li>

<li>The &#8220;behavioral&#8221; structure of a program, as embodied by its threads, is largely orthogonal to the program&#8217;s &#8220;static&#8221; structure, as embodied by packages, classes and methods. Since code is organized around the latter, developers can &#8220;see&#8221; and understand it. Since code is not organized around the behavioral structure (for example, the code does not contain explicit representations of the paths of individual threads), developers have a harder time seeing and understanding it.</li>

</ul>


<p>There are times when you really do need to understand how threads work in order to implement required functionality or else <a href="#">avoid simple but potentially serious mistakes</a>.</p>

<h4>What we&#8217;ll cover</h4>


<p>In this three-part series of posts we&rsquo;re going to cover several important concurrent programming concepts that every professional software developer needs to understand: serialism, parallelism, race conditions, synchronization, deadlocks and global lock orderings. The concepts form a logical progression that looks a little like an arms race: some problems lend themselves to a parallel solution, but parallelism gives rise to race conditions. We counter race conditions with synchronization (among other techniques), but synchronization leads to deadlocks (among other problems). And so we counter deadlocks with global lock orderings (among other techniques).</p>

<p>You&rsquo;ll note that I said &ldquo;among other problems&rdquo; and &ldquo;among other techniques&rdquo;. The treatment here doesn&rsquo;t pretend to be comprehensive. There are lots of important topics in concurrent programming, such as proper encapsulation, contention-induced (rather than compute-induced) performance issues, read/write locking, minimizing lock scope, fine- vs. coarse-grained locks, timeouts, forking and joining and on and on (and on). I believe however that the topics we&rsquo;re about to treat provide a nice context against which developers can more easily learn other topics. I&rsquo;ll probably write about some of the other topics eventually.</p>

<p>By the end of the series you&rsquo;ll have a basic foundation in multithreaded programming, one that I consider to be required for practicing software engineers.</p>

<p>Our presentation is Java-centric, but developers from other languages (especially C#) should still find the discussion useful.</p>

<h3>What is a thread?</h3>


<p>Let&rsquo;s begin by introducing the star of the show, the thread. The following is probably more accurately considered a description rather than a definition, even though it reads a little like the latter.</p>

<p>A thread is a sequential flow of control with its own program counter and call stack. It shares state, memory and resources with other threads in the same process. Since each thread gets its own call stack, local variables aren&rsquo;t shared. Instance and class variables, however, are shared across threads. It&rsquo;s also possible to define variables that exist outside of methods but are still local to a specific thread, and these are called <a href="http://en.wikipedia.org/wiki/Thread-local_storage">thread-local</a> variables.</p>

<p>OK, so that&rsquo;s what a thread is. What can we do with them?</p>

<h3>Serialism and parallelism</h3>


<p>In software development we&rsquo;re asked to solve different kinds of problem. We may be asked to write code that takes a bunch of information about a loan applicant and produces a verdict as to whether that applicant should get the loan. Maybe we have to write a web-based shopping cart. Or maybe we have to write code to make a guy&rsquo;s arms and legs flail about in a realistic fashion when he falls off a cliff in a video game.</p>

<p>For any given problem there are typically multiple ways to solve it, and different ways to categorize the solutions. One useful way of distinguishing solutions is to separate <em>serial</em> from <em>parallel</em> solutions. Let&rsquo;s look at that distinction in more detail.</p>

<h4>Serial approaches to solving problems</h4>


<p>Some problems have solutions that are essentially a single series of steps. If you&rsquo;re writing a home affordability calculator, for example, the steps might be as follows:</p>

<ol>
<li>Collect data from the user, such as their annual salary, the amount of the down payment, their monthly bill payments, whatever.</li>
<li>Crunch some numbers.</li>
<li>Show the maximum dollar amount the user can afford and an ad for a local Realtor.</li>
</ol>


<p>Our recipe for solving the &ldquo;home affordability problem&rdquo; is said to be <em>serial</em> because it&rsquo;s essentially just a series of steps to carry out. We might even go so far as to describing the problem itself as a serial problem, which is just a shorthand way of saying that the most plausible and reasonable solutions to the problem are serial solutions. Either way, the essence of serialism is that we have a series of steps that a single control flow can carry out.</p>

<p>Now let&rsquo;s look at the alternative to serialism, which would be parallelism.</p>

<h4>Parallel approaches to solving problems</h4>


<p>Some problems are amenable to solutions involving multiple concurrent control flows, which is to say that they have <em>parallel</em> solutions. To take a non-computing example, say you have a room with toys scattered all over the floor. You want the room clean. As potential participants to the cleanup effort you have yourself and three kids. A possibly-relevant piece of background information is that one child is entirely responsible for the mess.</p>

<p>Readers with young children will no doubt recognize this classic problem from the field of parenting algorithms. Fortunately, well-known serial and parallel solutions are available. The best approach in any given case depends strongly upon your goals:</p>

<ol>

<li>If you&#8217;re trying to emphasize fairness and personal responsibility, you might opt for the obvious serial solution even though it&#8217;s slower. (In reality this isn&#8217;t a serial solution; it inevitably involves close supervisory involvement by a supervisory parent thread. We can ignore that detail.)</li>

<li>If you&#8217;re in a big hurry because you need to get the kids off to school, you might choose the obvious parallel solution, despite the unfairness.</li>

<li>If you&#8217;re in an even bigger hurry you might choose the &#8220;other&#8221; serial solution. (Hint: it doesn&#8217;t involve any kids.)</li>

</ol>


<p>Whether we&rsquo;re talking about serialism or parallelism, there is a recurring concept, which is that of a flow of control. In the serial case we have exactly one flow. In the parallel case we have more.</p>

<p>Computer scientists, hardware engineers and software engineers spend a lot of time with the distinction between serialism and parallelism. Let&rsquo;s look at why that is.</p>

<h4>Serialism vs. parallelism: why do we care?</h4>


<p>In a word, performance. In many cases&mdash;not all, but many&mdash;parallel solutions are simply faster than serial solutions, owing to the &ldquo;many hands make light work&rdquo; effect. And from a practical perspective, that&rsquo;s the main reason we care about concurrency (i.e., parallelism) despite its many attendant complications.</p>

<p>The <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">next post in our series</a> explains what some of those complications are and some ways to overcome them.</p>

<div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>




<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/11/hashing-and-salting-passwords-with-spring-security-2/">Hashing and Salting Passwords With Spring Security 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-11T12:02:44-07:00" pubdate data-updated="true">Oct 11<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro"><span class="icon stickyNote">This post was originally written as a recipe for our book <a href="http://www.manning.com/wheeler/">Spring in Practice</a>, but we just didn&#8217;t have enough room to include it. It&#8217;s still (we think, anyway) a great recipe, so we&#8217;re making it available here free of charge. This will give readers of this website a chance to see the sort of recipe we&#8217;re including in the book.</span>

This material is based upon another post called <a href="http://springinpractice.com/2008/08/31/storing-passwords-securely/">Storing passwords securely</a>.</div>




<h3>Prerequisites</h3>


<p><a href="http://www.manning.com/wheeler/">4.3 Save user registrations</a></p>

<h3>Key Technologies</h3>


<p>Spring Security, hash functions (e.g., MD5, SHA-1)</p>

<h2>Background</h2>


<p>When you&rsquo;re building an application involving user passwords, one of the challenges is to protect the passwords from prying eyes. We generally want to protect user registration data in transit from the browser to the server to prevent eavesdroppers on the network from getting at that data. But it&rsquo;s not enough to protect the data in transit. It&rsquo;s as important to store it securely.</p>

<p>It may not be immediately clear why you need to store the passwords securely. If, for instance, you have a corporate firewall that prevents the bad guys on the outside from getting to your password store, then why bother?</p>

<p>There are a few different answers to that. First, one basic security principle is to take a layered approach. There are no security silver bullets, and so overreliance on any particular process or technology (such as firewalls) creates unnecessary risk. Storing passwords securely gives you protection if a bad guy somehow gets in. (And it happens.)</p>

<p>A second answer is that the question makes the faulty assumption that the bad guys are on the outside. In an organization of any size, you can&rsquo;t be sure that you don&rsquo;t have bad guys on the inside, and the last thing you want them to do is use user passwords to log into your websites, or even other websites. The latter is a real concern since many users tend to use the same (or similar) passwords on multiple sites.</p>

<p>A third answer is that even if your organization is small (maybe it&rsquo;s just you), you&rsquo;d like to be able to tell your users in your privacy policy that their passwords are stored securely, and that no one&mdash;not even the technical folks who administer the site&mdash;has any ability to see the stored passwords. That gives your users greater confidence that their information is safe and that you&rsquo;re taking security seriously.</p>

<p>So let&rsquo;s get to it!</p>

<h2>Problem</h2>


<p>You want to store passwords securely to prevent anybody&mdash;even yourself and other technical staff&mdash;from being able to view them.</p>

<h2>Solution</h2>


<p>In this recipe we&rsquo;re going to use Spring Security 2 to store passwords securely. We&rsquo;ll also show how to authenticate against secured passwords.</p>

<p>Spring Security makes it fairly easy to store passwords securely. The actual storage mechanism (database, LDAP or other) doesn&rsquo;t really matter since that&rsquo;s abstracted away, which is nice.</p>

<p>Before we jump into the how-to part of the recipe, let&rsquo;s briefly examine hash functions and how they work, since we&rsquo;ll need this background to understand what we&rsquo;re doing in the subsequent discussion.</p>

<h3>Understanding hash functions</h3>


<p>The idea behind this recipe is that we want to store passwords in encrypted form in the persistent store. There are in general two different approaches to encryption here: ciphers and hash functions. The two are similar in that each provides a way to encrypt data, but they differ in that only ciphers provide an easy way (assuming you know a secret key) to decrypt the data. Hash functions don&rsquo;t provide for easy decryption; hence they are sometimes referred to as one-way hash functions. All hash functions, however, are one-way.</p>

<p>When storing encrypted passwords, the typical practice is to use a hash function, such as MD5 or SHA-1, to encrypt the password before saving it. The reason for preferring a hash function to a cipher is that we don&rsquo;t usually want anybody to be able to recover the password: we never (or should never) display it on the screen or in e-mails, for example. A string of plaintext encrypted by a hash function is called a <em>hash</em>.</p>

<p>Here are a couple of examples of hashed text:</p>

<ul>
<li><code>4fe0e930dd0adf9daaba0b7219bbe1f1bbb7809c</code></li>
<li><code>3af00c6cad11f7ab5db4467b66ce503e</code></li>
</ul>


<p>The first string is an SHA-1 hash of the string <code>dardy</code>, and the second is an MD5 hash of the string <code>friend</code>. You can easily Google for free online hash calculators, both for MD5 and for SHA-1.</p>

<p>You might ask how we can use stored password hashes to authenticate users if we can&rsquo;t recover the plaintext password from the hash. The answer is that we don&rsquo;t compare plaintext passwords, but rather we compare the hashes. When the user submits a username/password pair, we hash the submitted password and compare that hash with the stored hash. If the two match, then we conclude that the submitted password was correct.</p>

<p>We can draw this conclusion due to a special property of hash functions: in general, different plaintext inputs map to different hashes. That is, in general, different plaintext inputs very, very rarely &ldquo;collide.&rdquo; There are of course limits to this non-collision, but for practical purposes we can assume that different passwords will have different hashes. So if the hashes match, then the submitted password was correct.</p>

<p>Sound good? Let&rsquo;s start with the authentication side of things, and then we&rsquo;ll tackle user registrations.</p>

<h3>Configuring your app for authentication against secured passwords</h3>


<p>When discussing secure storage of passwords, there are really two different sides to consider. First, during the registration process (or else during account provisioning, if that&rsquo;s how you&rsquo;re doing things), you have to obfuscate the password in some fashion before saving it to the data store. And secondly you have to be able to use those obfuscated passwords during authentication.</p>

<p>We&rsquo;re going to start with the authentication part first, since that&rsquo;s pretty easy to set up. We&rsquo;re going to assume the following:</p>

<ul>
<li>Your app has an existing user account model is called <code>Account</code>, with a corresponding <code>AccountDao</code> interface and implementation to support CRUD operations.</li>
<li>You also have a service bean, which we&#8217;ll assume is <code>AccountServiceImpl</code>, that supports user registrations. The registrations store the passwords as plaintext.</li>
<li>Your app is configured to support Spring Security 2 username/password authentication against plaintext passwords. You&#8217;re using two separate application context files: <code>applicationContext.xml</code> and <code>applicationContext-security.xml</code>, and you&#8217;re using namespace configuration in <code>applicationContext-security.xml</code>.</li>
</ul>


<p>Given the assumptions above, it isn&rsquo;t hard to modify the configuration to use hashed passwords during the login process. Let&rsquo;s see how.</p>

<h3>Create some user accounts in the database with hashed passwords</h3>


<p>Create an account or two in your database with SHA-1 hashed passwords. You can use the following website to compute SHA-1 hashes of plaintext passwords:</p>

<p><a href="http://sha1-hash-online.waraxe.us/"><a href="http://sha1-hash-online.waraxe.us/">http://sha1-hash-online.waraxe.us/</a></a></p>

<p>For example, the SHA-1 hash of <code>flower</code> is <code>5a46b8253d07320a14cace9b4dcbf80f93dcef04</code>. When entering your hash into the hash calculator at the link above, be sure not to enter a carriage return character, as that&rsquo;s significant and will completely change the hash. Anyway, create the database records, using the SHA-1 hash as the password.</p>

<h3>Update applicationContext-security.xml to authenticate against hashed passwords</h3>


<p>We want to add something called a <code>PasswordEncoder</code> to our Spring configuration. <code>PasswordEncoder</code> is an interface defining a contract for computing hashes. There are different <code>PasswordEncoder</code> implementations according to the hash function you want to apply. Two popular options, for example, are <code>Md5PasswordEncoder</code> for MD5 hashes and <code>ShaPasswordEncoder</code> for (you guessed it) SHA. We&rsquo;ll use SHA here but either choice is legitimate. Don&rsquo;t use <code>Md4PasswordEncoder</code> unless you are working with a legacy system, as it is known to be weak.</p>

<p>The namespace configuration supports <code>PasswordEncoder</code>s. Just add a single line to your <code>authentication-provider</code> element like this:</p>

<pre>&lt;authentication-provider&gt;
    &lt;password-encoder hash="sha" /&gt;
    &lt;jdbc-user-service data-source-ref="dataSource" /&gt;
&lt;/authentication-provider&gt;</pre>


<p>Yep, that&rsquo;s it! This configuration sets SHA-1 as our hash algorithm.</p>

<h3>Try it out</h3>


<p>Try logging in using the account you just created. Type in the plaintext password, not the hash. The login should work. If so, congratulations, your app authenticates against secure passwords! (You&rsquo;ll need to convert whatever other passwords you have into SHA-1 hashes.)</p>

<p>Now we&rsquo;re going to jump over to the other side, which is storing passwords securely during either the registration or account provisioning process. We&rsquo;ll assume a registration process but the technique is the same in either case.</p>

<h3>Configuring your app to secure passwords during registration</h3>


<p>Saving secured passwords is somewhat more involved than authenticating against them. Part of the reason is that we&rsquo;d like to use the same <code>PasswordEncoder</code> instance during registration that we used during login, partly just because it&rsquo;s &ldquo;cleaner&rdquo;, and relatedly, because it allows us to avoid having to coordinate two separate <code>PasswordEncoder</code> instances should we decide to switch from SHA-1 to MD5, or add salt, or whatever. Basically it boils down to our being good adherents to the <a href="http://en.wikipedia.org/wiki/DRY_code">DRY principle</a>.</p>

<p>Unfortunately, the namespace configuration for <code>authentication-provider</code> doesn&rsquo;t accept an externally-defined <code>PasswordEncoder</code> bean; you have to use the <code>password-encoder</code> namespace element inside of <code>authentication-provider</code>. So instead of using the namespace configuration, we&rsquo;re going to drop back to good, old-fashioned bean configuration.</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security-2.0.4.xsd"&gt;

    &lt;-- 1 --&gt;
    &lt;beans:bean id="accountDao" class="example.HbnAccountDao" /&gt;
    
    &lt;-- 2 --&gt;
    &lt;beans:bean id="userDetailsService"
        class="example.UserDetailsServiceImpl"
        p:userDao="accountDao" /&gt;

    &lt;-- 3 --&gt;
    &lt;beans:bean id="passwordEncoder"
        class="org.springframework.security.providers.encoding.ShaPasswordEncoder" /&gt;

    &lt;-- 4 --&gt;
    &lt;beans:bean
        class="org.springframework.security.providers.dao.DaoAuthenticationProvider"
        p:userDetailsService-ref="userDetailsService"
        p:passwordEncoder-ref="passwordEncoder"&gt;
        &lt;custom-authentication-provider /&gt;
    &lt;/beans:bean&gt;
&lt;/beans:beans&gt;</pre>


<p>In the code above, we begin by creating a data access object for user accounts <span class="cueball">1</span>. Next we create an implementation of Spring&rsquo;s <code>UserDetailsService</code> interface, which we&rsquo;ve called <code>UserDetailsServiceImpl</code> <span class="cueball">2</span>. <code>UserDetailsService</code> is essentially a service provider interface for the <code>DaoAuthenticationProvider</code>; it allows the latter to obtain <code>UserDetails</code> instances for authentication purposes. Third we create the <code>PasswordEncoder</code> itself <span class="cueball">3</span>; in this case we&rsquo;re using <code>ShaPasswordEncoder</code>, which hashes passwords using SHA (the default strength is SHA-1). Finally, we&rsquo;re creating a <code>DaoAuthenticationProvider</code> <span class="cueball">4</span> and injecting it with the <code>userDetailsService</code> and <code>passwordEncoder</code> we created previously. We also include a <code>custom-authentication-provider</code> element to register our authentication provider with an <code>AuthenticationManager</code> hiding in the background.</p>

<p><img src="http://wheelersoftware.s3.amazonaws.com/articles/spring-security-hash-salt-passwords/authn.jpg" alt="Authentication" /></p>

<p>For the curious, the <code>AuthenticationManager</code> in question is <code>ProviderManager</code>, a provider-based implementation of the <code>AuthenticationManager</code> interface, and it is automatically created by the <code>http</code> element unless you&rsquo;ve already defined one explicitly. See the figure above for a class diagram.</p>

<p>That takes care of configuration. Let&rsquo;s see what we need to do in order to save registrations with a hashed password.</p>

<h3>Update AccountServiceImpl to hash the password</h3>


<p>There are two updates you&rsquo;ll need to make to your <code>AccountServiceImpl</code> bean. The first one is that you&rsquo;ll need to provide a setter for a <code>PasswordEncoder.</code> And once you create that setter, go back to your application context configuration and make sure you&rsquo;re actually injecting a <code>PasswordEncoder</code> into the <code>AccountServiceImpl</code> bean.</p>

<p>The second update is to modify your <code>registerAccount()</code> method in <code>AccountServiceImpl</code> so that it hashes passwords:</p>

<pre>public void registerAccount(Account account) {
    accountDao.save(account); // 1
    String encPassword =
        passwordEncoder.encodePassword(account.getPassword(), null); // 2
    account.setPassword(encPassword); // 3
    accountDao.save(account); // 4
}</pre>


<p>First we save the account with the plaintext password <span class="cueball">1</span>. There&rsquo;s a reason for saving the account before actually hashing the password, but we&rsquo;ll have to wait until later in the recipe for the reason why. Then we hash the password <span class="cueball">2</span>, update it on the account <span class="cueball">3</span>, and save the account with the new password <span class="cueball">4</span>. The account now has a hashed password in the database.</p>

<p>Good job! You&rsquo;re now saving secured passwords into your database, and you&rsquo;re able to authenticate against them.</p>

<p>But I&rsquo;m afraid that it&rsquo;s time for some bad news.</p>

<h3>Meet the dictionary attack</h3>


<p>Our new password storage scheme is off to a good start. It certainly prevents casual observers from accidentally seeing user passwords. But it does little to thwart the efforts of a semi-determined attacker. Let&rsquo;s talk about the dictionary attack.</p>

<p>To understand how it works, recall that hashing different strings generally results in different hashes. We can use that fact to create a big lookup table for a dictionary of potential passwords. The lookup table takes a hash and then returns the string that generated it.</p>

<p>As luck would have it, we don&rsquo;t even have to create our own lookup table. Helpful folks on the Internet have already done it for us. For instance, go to</p>

<p><a href="http://tools.benramsey.com/md5/"><a href="http://tools.benramsey.com/md5/">http://tools.benramsey.com/md5/</a></a></p>

<p>and enter the MD5 hash we presented earlier; namely,</p>

<p><code>3af00c6cad11f7ab5db4467b66ce503e</code></p>

<p>Voil&agrave;! You&rsquo;ve unhashed a hash. This is called a <em>dictionary attack</em>.</p>

<p>If an attacker were to acquire a list of hashed passwords, he could make quick work of it using a dictionary of the sort just described. In some contexts that might be very bad.</p>

<h3>Add a little salt to that hash</h3>


<p>Ideally we&rsquo;d like to thwart even the semi-determined attacker. To improve our scheme, we now introduce the idea of salt.</p>

<p>The strategy behind salt is to make it much more painful for the attacker to recover hashed passwords. Instead of allowing ourselves to be attacked by a single well-known dictionary, we are going to force the attacker to create a new and unique dictionary for every single password he wants to try to recover. Can he still do it? Sure. But it&rsquo;s just a lot more work now. We&rsquo;ve effectively eliminated merely semi-determined attackers from the pool of attackers. That&rsquo;s nothing to scoff at since their numbers are large.</p>

<p>Here&rsquo;s how we do it. Instead of hashing passwords, we concatenate a string&mdash;called a salt&mdash;to the plaintext password, and then hash the concatenated string. This effectively breaks the standard dictionary attack, because now all of the hashes in your password store are &ldquo;new.&rdquo;</p>

<p>What happens, though, if we use a single, common salt across all users? While this is better than using no salt at all, it&rsquo;s still not hard to overcome if the attacker knows the salt. The attacker simply has to create a single new dictionary, this time concatenating the salt to each individual dictionary word before hashing. Then it&rsquo;s the same as before.</p>

<p>We want to make things harder for him. Instead of using a common salt across all users, we want the salt to be different for each user. That way, the attacker has to create a new dictionary for every single user he wants to attack. Again, he can do it, but it&rsquo;s much more time-consuming.</p>

<p>One good way to create a salt is to use some property of the user. It is better to choose something that won&rsquo;t change, such as a numeric primary key, than it is to choose something that might change, such as an e-mail address. If you use (say) e-mail addresses for salt, and a user changes his e-mail address, he won&rsquo;t be able to log in anymore because the authentication system won&rsquo;t be able to create the correct hash.</p>

<p>Usernames are a reasonable choice as they don&rsquo;t usually change, but a numeric primary key is even better, given the specific scheme Spring Security uses to concatenate the password with the salt. Spring Security uses braces to delimit the salt, and hence disallows braces inside the salt itself. For example, if my password/salt is <code>college/willie</code>, then Spring Security will hash the string <code>college{willie}</code>. You may well want to allow braces in the username (it&rsquo;s common for gamers to include such characters in their usernames). You can avoid the whole issue&mdash;including the added complexity of disallowing braces in usernames&mdash;by using the user&rsquo;s numeric primary key, if the user schema supports that.</p>

<p>So let&rsquo;s do just that.</p>

<h3>Update applicationContext-security.xml to handle salt</h3>


<p>All we need to do to <code>applicationContext-security.xml</code> is add a <code>SaltSource</code> bean and inject it into the <code>DaoAuthenticationProvider</code>. We do this in the listing below.</p>

<pre>&lt;beans:bean id="passwordEncoder"
    class="org.springframework.security.providers.encoding.ShaPasswordEncoder" /&gt;
&lt;beans:bean id="saltSource"
    class="org.springframework.security.providers.dao.salt.ReflectionSaltSource"
    p:userPropertyToUse="id" /&gt;
&lt;beans:bean
    class="org.springframework.security.providers.dao.DaoAuthenticationProvider"
    p:userDetailsService-ref="userDetailsService"
    p:passwordEncoder-ref="passwordEncoder"
    p:saltSource-ref="saltSource"&gt;
    &lt;custom-authentication-provider /&gt;
&lt;/beans:bean&gt;</pre>


<p>We mentioned above that it&rsquo;s possible to use a global salt, but that it&rsquo;s not as good as using a salt that varies from user to user. (For a more detailed explanation, please see my article <a href="http://springinpractice.com/2008/08/31/storing-passwords-securely/">Storing Passwords Securely</a>.) <code>ReflectionSaltSource</code> allows us to use a property of our user (specifically, a property of a <code>UserDetails</code> instance; we&rsquo;ll see that shortly) to provide a salt. As with the <code>PasswordEncoder</code>, we&rsquo;ve defined the <code>SaltSource</code> explicitly as a bean so we can inject it into <code>AccountServiceImpl</code>.</p>

<h3>Update AccountServiceImpl to salt the password</h3>


<p>The first step is to add a setter for a <code>SaltSource</code> instance to <code>AccountServiceImpl</code>, and wire it up in your application context file.</p>

<p>Next, we&rsquo;ll once again update <code>registerAccount()</code>.</p>

<pre>public void registerAccount(Account account) {
    accountDao.save(account);
    UserDetailsAdapter userDetails = new UserDetailsAdapter(account); // 1
    String password = userDetails.getPassword();
    Object salt = saltSource.getSalt(userDetails); // 2
    account.setPassword(passwordEncoder.encodePassword(password, salt)); // 3
    accountDao.save(account);
}</pre>


<p>As before, we&rsquo;re saving the account with a plaintext password first. I promised earlier to explain why I&rsquo;m doing that, so here&rsquo;s the explanation. In many cases (such as when using Hibernate), entities aren&rsquo;t assigned IDs until after they&rsquo;re persisted. Since we&rsquo;re basing our salt on the ID, we need to save the account before generating the salt and hash.</p>

<p>Next we wrap the <code>account</code> with a class we wrote to adapt our <code>Account</code> class to the <code>UserDetails</code> interface; namely, <code>UserDetailsAdapter</code> <span class="cueball">1</span> (we&rsquo;ll see it momentarily).</p>

<p>We&rsquo;re using the <code>SaltSource</code> to get the salt from our <code>UserDetailsAdapter</code> <span class="cueball">2</span>. As we saw in the configuration, this salt source uses reflection to grab the account ID and present it to the <code>PasswordEncoder</code> as salt <span class="cueball">3</span>.</p>

<p>The next listing shows our <code>UserDetailsAdapter</code> class, which again is just an example of a <code>UserDetails</code> implementation. I&rsquo;m extending the <code>org.springframework.security.userdetails.User</code> class for convenience, but note that that&rsquo;s a <code>UserDetails</code> implementation.</p>

<pre>package examples;

import java.util.Set;

import org.springframework.security.GrantedAuthority;
import org.springframework.security.GrantedAuthorityImpl;
import org.springframework.security.User;

public class UserDetailsAdapter extends User { // 1
    private final Long id;
    
    public UserDetailsAdapter(Account acct) {
        super(acct.getUsername(), acct.getPassword(), acct.isEnabled(),
                true, true, true, toAuthorities(acct.getAuthorityNames()));
        this.id = acct.getId();
    }
    
    private static GrantedAuthority[] toAuthorities(Set&lt;String&gt; authNames) {
        GrantedAuthority[] auths = new GrantedAuthority[authNames.size()];
        int i = 0;
        for (String authName : authNames) {
            auths[i++] = new GrantedAuthorityImpl(authName);
        }
        return auths;
    }
    
    public Long getId() {
        return id;
    }
}</pre>


<p>Again, we&rsquo;re just extending <code>User</code> for convenience <span class="cueball">1</span>; the important thing is that our <code>UserDetailsAdapter</code> implements <code>UserDetails</code>, which allows <code>DaoAuthenticationProvider</code> to use it to perform authentication.</p>

<p>There you have it&mdash;salted and hashed passwords. This won&rsquo;t stop the most determined attackers from unmasking your passwords, but it will stop most others.</p>

<h2>Discussion</h2>


<p>The ideas in this recipe can also be applied to storing answers to challenge questions in a secure way (for instance, &ldquo;What is your mother&rsquo;s maiden name?&rdquo;). The relevant similarities are that the information should be secured (otherwise it might be used to recover or reset passwords on other websites), and that we typically don&rsquo;t need to decrypt answers to challenge questions. It might be helpful to convert the answers to some kind of canonical form before saving them, such as converting everything to uppercase, removing punctuation and trimming extra whitespace, just to eliminate minor variations in the way that people answer the question.</p>

<p>It is also useful to understand where this recipe does not apply. In most cases where you want to store data securely, you need to be able to decrypt the stored data. A good example is storing credit card numbers securely for Payment Card Industry (PCI) compliance. You need to be able to recover the credit card number so you can apply it to customer orders. One-way hashes, which support encryption but not decryption, will not help you with this.</p>

<p>When you store passwords using hashes, you cannot offer password recovery functionality to end users, because the system doesn&rsquo;t have any way to actually recover the passwords. All you can offer is the ability to reset passwords. This is better from a security perspective anyway since there&rsquo;s always the chance that you might disclose a password to somebody other than the intended recipient, and that somebody might use it to access not only your site but other sites, as we discussed in the background above.</p>

<h2>Resources</h2>


<p>If you found this article helpful, you may also find the following useful:</p>

<ul>
<li><a href="http://springinpractice.com/2008/08/31/storing-passwords-securely/">Storing passwords securely</a> - Another post I wrote about storing passwords securely, but treating the subject more generally as opposed to being Spring-specific. The discussion about hashing and salting is a little more in-depth, and there&#8217;s also a section on key strengthening, which can make your passwords even more secure.</li>
<li><a href="http://www.manning.com/wheeler/">Spring in Practice</a> - A book that my collaborators and I are writing for Manning Publications about Spring generally. We have lots of information about Spring Security, including chapters on user registrations, authentication and authorization.</li>
<li><a href="http://springinpractice.wordpress.com/2008/09/06/login-remember-me/">Excerpt: Login and remember-me discussion</a> - An excerpt from Spring in Practice that compares normal username/password authentication with remember-me authentication.</li>
</ul>




<div class="endnote">Post migrated from my Wheeler Software site.</div>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/01/some-thoughts-on-the-new-springsource-maintenance-policy/">Some Thoughts on the New SpringSource Maintenance Policy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-01T15:38:35-07:00" pubdate data-updated="true">Oct 1<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At the risk of getting myself involved in a highly charged political issue, I have some thoughts about the <a title="new SpringSource maintenance policy" href="http://www.springsource.com/products/enterprise/maintenancepolicy">new SpringSource maintenance policy</a> that I wanted to share. Not sure that I know what I&rsquo;m talking about, but I have no doubt that others will let me know if I&rsquo;m totally off-base.</p>

<p>Initially I was a little disappointed when I heard the news about the change. I don&rsquo;t have anything against capitalism, and I think that the Spring developers absolutely ought to benefit financially from all the good work that they&rsquo;ve been doing over the years. The disappointment was really just a function of my being a bit of a cheapskate: I&rsquo;m happy to contribute on the forums, contribute JIRA issues, even the occasional code patch, but I suppose I&rsquo;ve grown too used to being able to download the latest and greatest for free.</p>

<p>But I found out that I misinterpreted the part about &ldquo;major&rdquo; releases in an important way, and now I feel a lot better about things.</p>

<p>I thought that SpringSource was saying that the community would be able to download binaries for 3.0, 4.0, 5.0 etc. for free, as well as 3.x (x &gt; 0) releases as long as the 3.x releases were released within the first three months of the 3.0 release.</p>

<p>I&rsquo;m happy to report that that&rsquo;s totally wrong.</p>

<p>It turns out that the community will have access to binaries for 3.0, 3.1, 3.2, 3.3, etc., as they appear. The for-pay releases will be the 3.1.x (x &gt; 0) releases that come out three months after the initial 3.1 release. Don&rsquo;t take my word for it though. It&rsquo;s <a title="Rod Johnson interview" href="http://java.dzone.com/news/qa-with-rod-johnson-over-sprin">right here</a> and <a title="FAQs" href="http://www.springsource.com/products/enterprise/maintenancepolicy/faq">here too</a>.</p>

<p>I can definitely live with that. Sure, I&rsquo;d prefer to download 3.1.5 for free, but it&rsquo;s not going to kill me to wait for 3.2. I think that there are probably a lot of developers who would feel the same way.</p>

<p>I have to wonder, though, whether SpringSource might do a better job explaining the change. It&rsquo;s pretty easy to read</p>

<blockquote>After a new major version of Spring is released, community maintenance updates will be issued for three months to address initial stability issues. Subsequent maintenance releases will be available to SpringSource Enterprise customers. Bug fixes will be folded into the open source development trunk and will be made available in the next major community release of the software.</blockquote>


<p>and think that you&rsquo;re going to have to wait a year for an update. I interpret &ldquo;major version&rdquo; as meaning Spring 2, Spring 3, etc. Maybe that&rsquo;s not the way SpringSource thinks of major versions (though that&rsquo;s news to me), but it doesn&rsquo;t really matter what SpringSource thinks &ndash; what matters is what the Spring community thinks, and I can&rsquo;t be the only one who read the above passage thinking that we&rsquo;d have to pay for version 3.3.</p>

<p>My understanding is that this change is about getting enterprises to start paying for Spring while letting smaller shops and individual developers still have access to pretty recent stuff. Enterprises are slower about upgrading versions. So say you&rsquo;re an enterprise and you built an app against version Spring 3.0.2. It&rsquo;s more painful for you to upgrade to version 3.1 than it is to just buy the enterprise license and get your 3.0.x upgrades, so you buy the license. On the other hand, smaller organizations are in many cases fine with going from 3.0.2 to 3.1, as are many individual developers (indeed, I think a lot of individual developers eagerly await new releases), so they can still use it for free without too much inconvenience. No doubt some smaller organizations and developers will be inconvenienced though.</p>

<p>If my understanding is correct, I think SpringSource ought to consider explaining it in roughly that way instead of this:</p>

<blockquote>&#8220;The maintenance policy provides IT teams responsible for building and running mission-critical production systems with the quality, assurance and peace of mind that comes from reliable, predictable and guaranteed support direct from the source, said Mark Brewer, vice president of enterprise delivery for SpringSource. And, the policy will always give the developer community access to the same cutting-edge innovations they have come to expect with Spring.&#8221;</blockquote>


<p>When developers read the above, they hear &ldquo;blah blah blah.&rdquo; Developers hate that kind of explanation. I assume that since Brewer is VP of enterprise delivery he&rsquo;s addressing enterprise customers more than he is the community, but (1) it&rsquo;s important to address the community since you don&rsquo;t want people defecting from the platform, and (2) there&rsquo;s a way to present the explanation so that it&rsquo;s palatable to enterprises. I am myself in corporate IT leadership, and if somebody told me that the enterprise license allows you to get bugfixes without having to upgrade from 3.0.x to 3.1, I would be able to see value in that.</p>

<p>Anyway, I&rsquo;m glad to discover that the situation is not what I had originally thought, and to my mind SpringSource is striking a reasonable balance between their desire (and right) to build a profitable business around Spring vs. their desire to maintain a supportive developer community. They just need to work on the communication. :&ndash;)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/09/14/optimistic-locking-with-spring-data-rest/">Optimistic locking with Spring Data REST</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/07/octopress-migration/">Octopress migration</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/08/seajug-talk-on-spring-data-jpa-spring-data-rest-and-spring-hateoas/">SeaJUG talk on Spring Data JPA</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/08/spring-in-practice-now-available/">Spring in Practice now available</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/09/renaming-node-classes-when-using-spring-data-neo4j/">Renaming node classes when using Spring Data Neo4j</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williewheeler">@williewheeler</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williewheeler',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Willie Wheeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
